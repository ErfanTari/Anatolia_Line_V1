<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Anatolia — Live Production (Static)</title>
  <style>
  :root { --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b; }
  :root { --bg:#f8fafc; --card:#fff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b; --accent:#2563eb; --success:#047857; --danger:#dc2626; }
  *{box-sizing:border-box} html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial;background:var(--bg);color:var(--text)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .header{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);background:var(--card);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .header .spacer{flex:1}
  .small{color:var(--muted);font-size:12px}
  .title{font-weight:600}
  .grid{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
  button{font:inherit}
  .container{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}
  .header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);background:var(--card);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .header-left{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .header .title{font-weight:600;font-size:18px}
  .header .small{color:var(--muted);font-size:12px}
  .spacer{flex:1 1 auto}
  .search-bar{display:flex;flex-wrap:wrap;align-items:center;gap:8px}
  .search-inputs{display:flex;gap:4px}
  .search-inputs input{width:56px;padding:6px 8px;border:1px solid var(--border);border-radius:10px;font-size:13px}
  .search-button,.button{border:1px solid var(--border);background:#fff;padding:6px 12px;border-radius:12px;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  .search-button{background:var(--accent);color:#fff;border-color:var(--accent)}
  .search-button:hover{filter:brightness(0.95)}
  .button:hover{background:#f6f7f9}
  .quick-buttons{display:flex;gap:6px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  @media (min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  .card{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row{display:flex;align-items:baseline;justify-content:space-between;gap:8px}
  .kvgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:8px}
  .card{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);display:flex;flex-direction:column;gap:12px}
  .row{display:flex;align-items:flex-start;justify-content:space-between;gap:8px}
  .line-label{font-size:16px;font-weight:600}
  .line-sub{font-size:12px;color:var(--muted)}
  .kvgrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (min-width:900px){.kvgrid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .k{font-size:11px;color:var(--muted)} .v{font-weight:600}
  .button{border:1px solid var(--border);background:#fff;padding:6px 10px;border-radius:12px;font-size:12px;cursor:pointer}
  .button:hover{background:#f6f7f9}
  .k{font-size:11px;color:var(--muted)} .v{font-weight:600;font-size:13px}
  .footer{text-align:center;font-size:12px;color:var(--muted);margin:24px 0}
  .modal-outer{position:fixed;inset:0;display:flex;z-index:50}
  .modal-backdrop{flex:1;background:rgba(0,0,0,.2)}
  .modal{width:420px;background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 24px rgba(0,0,0,.12);padding:20px;overflow:auto}
  .field{margin:10px 0} .field label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
  .field input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:12px;font-size:14px}
  .modal-outer{position:fixed;inset:0;display:flex;z-index:50;background:rgba(15,23,42,.28);align-items:center;justify-content:center;padding:16px}
  .side-modal{margin:0;margin-left:auto;width:420px;background:#fff;border-left:1px solid var(--border);box-shadow:-8px 0 24px rgba(0,0,0,.12);padding:20px;max-height:100vh;overflow:auto;border-radius:16px 0 0 16px}
  .center-modal{width:100%;max-width:460px;background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;max-height:100vh;overflow:auto;box-shadow:0 20px 50px rgba(15,23,42,.15)}
  .history-modal{width:100%;max-width:920px;background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;max-height:96vh;overflow:hidden;display:flex;flex-direction:column;gap:16px;box-shadow:0 20px 60px rgba(15,23,42,.18)}
  .field{margin:10px 0} .field label{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px}
  .field input,.field textarea,.field select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:12px;font-size:14px;font-family:inherit}
  .field textarea{min-height:80px;resize:vertical}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
  .button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .button.danger{border-color:var(--danger);color:var(--danger)}
  .button.success{border-color:var(--success);color:var(--success)}
  .toast{position:fixed;top:16px;right:16px;padding:12px 16px;border-radius:12px;background:var(--card);border:1px solid var(--border);box-shadow:0 10px 25px rgba(15,23,42,.12);font-size:13px;min-width:220px;z-index:60;display:flex;align-items:center;gap:8px}
  .toast.success{border-color:var(--success);color:var(--success)}
  .toast.error{border-color:var(--danger);color:var(--danger)}
  .filters{display:flex;flex-wrap:wrap;gap:12px}
  .filters .field{margin:0;min-width:160px}
  .history-table{width:100%;border-collapse:collapse}
  .history-table th,.history-table td{border-bottom:1px solid var(--border);padding:8px 6px;font-size:13px;text-align:left}
  .history-table tbody tr{cursor:pointer}
  .history-table tbody tr:hover{background:#f9fafb}
  .history-body{flex:1;overflow:auto;border:1px solid var(--border);border-radius:12px}
  .history-body table{width:100%;border-collapse:collapse}
  .history-empty{padding:40px;text-align:center;color:var(--muted)}
  .history-detail{border:1px solid var(--border);border-radius:12px;padding:16px;max-height:200px;overflow:auto;background:#f9fafb;font-size:12px}
  .login-wrap{min-height:100vh;display:grid;place-items:center;padding:16px}
  .login{width:100%;max-width:380px;background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
  .login{width:100%;max-width:380px;background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.06);display:flex;flex-direction:column;gap:12px}
  .login .field{margin:0}
  .login h1{margin:0;font-size:18px}
  .login button{width:100%;font-weight:600}
  .tag{display:inline-flex;align-items:center;padding:2px 6px;border-radius:999px;font-size:10px;background:#e2e8f0;color:#475569;margin-left:6px}
  .pill{padding:2px 8px;border-radius:999px;background:#e2e8f0;font-size:11px;color:#475569}
  .history-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
  .history-actions .button{padding:6px 10px}
  .history-actions input[type="file"]{display:none}
  .row-buttons{display:flex;gap:8px}
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
  (function(){
    var STORAGE_KEYS={LINES:'anatolia.lines',HISTORY:'anatolia.history',COUNTERS:'anatolia.counters'};
    var LINE_META={
      LA:{id:'LA',label:'First line',short:'First',number:1},
      LB:{id:'LB',label:'Second line',short:'Second',number:2},
      LC:{id:'LC',label:'Third line',short:'Third',number:3}
    };
    var DEFAULT_LINES={
      LA:{line:'LA',body:'R21',thickness_mm:18,size:'160x320',engobe:'EN-12A',product_code:'BG-Topaz-Polished-160x320',protection_glaze:'Silckyrock',kiln_temperature_C:1223,kiln_cycle:'KILN-18mm-Polished',surface:'Polished'},
      LB:{line:'LB',body:'ALB10',thickness_mm:12,size:'120x280',engobe:'EN-08B',product_code:'Onyx-Matt-120x280',protection_glaze:'Drygranul-X',kiln_temperature_C:1218,kiln_cycle:'KILN-12mm-Matt',surface:'Matt'},
      LC:{line:'LC',body:'R20',thickness_mm:10,size:'90x180',engobe:'EN-20C',product_code:'FrenchVanilla-Honed-90x180',protection_glaze:'X-Glaze',kiln_temperature_C:1220,kiln_cycle:'KILN-10mm-Honed',surface:'Honed'}
    };

    function deepClone(obj){return JSON.parse(JSON.stringify(obj));}
    function pad(value,length){var str=String(value==null?'':value);while(str.length<length){str='0'+str;}return str;}
    function safeLoad(key,fallback){try{var raw=localStorage.getItem(key);if(!raw)return deepClone(fallback);var parsed=JSON.parse(raw);return parsed;}catch(err){console.error('localStorage load error',err);queueToast('Storage error — using defaults','error');return deepClone(fallback);}}
    function safeSet(key,value){try{localStorage.setItem(key,JSON.stringify(value));return true;}catch(err){console.error('localStorage write error',err);queueToast('Unable to save data — storage may be full.','error');return false;}}

    function getIstanbulDate(){var now=new Date();try{var localeString=now.toLocaleString('en-US',{timeZone:'Europe/Istanbul'});return new Date(localeString);}catch(err){return now;}}
    function formatDateKey(date){var y=date.getFullYear();var m=pad(date.getMonth()+1,2);var d=pad(date.getDate(),2);return y+'-'+m+'-'+d;}
    function formatRunCode(dateKey,lineNumber,counter){var parts=dateKey.split('-');var yy=parts[0].slice(-2);return yy+parts[1]+parts[2]+'_L'+lineNumber+'_C'+pad(counter,2);}
    function nextCounterFor(dateKey,lineId){var key=dateKey+'|'+lineId;return state.counters[key]||1;}
    function incrementCounter(dateKey,lineId){var key=dateKey+'|'+lineId;var next=(state.counters[key]||1)+1;state.counters[key]=next;persistCounters();}
    function ensureCounter(dateKey,lineId,counter){var key=dateKey+'|'+lineId;var current=state.counters[key]||1;if(counter>=current){state.counters[key]=counter+1;}}

    function rebuildCountersFromHistory(){state.counters={};state.history.forEach(function(item){if(item.production_date&&item.line_id&&item.counter_of_day!=null){ensureCounter(item.production_date,item.line_id,item.counter_of_day);}});persistCounters();}

    var state={
      authed:false,
      // The original code had redundant lines and a missing comma here.
      // The fixed version initializes the lines by cloning the defaults
      // and sets up the rest of the application state variables.
      lines:deepClone(DEFAULT_LINES),
      editing:null,
      finishing:null,
      history:[],
      counters:{},
      toast:null,
      toastTimer:null,
      historyOpen:false,
      historyFilters:{dateFrom:'',dateTo:'',exactDate:'',line:'',text:''},
      historyDetail:null,
      searchInputs:{day:'',month:'',year:''}
    };
    function h(t,a,c){var e=document.createElement(t);a=a||{};c=c||[];for(var k in a){var v=a[k];if(k==='class')e.className=v;else if(k.indexOf('on')===0)e.addEventListener(k.slice(2).toLowerCase(),v);else if(k==='html')e.innerHTML=v;else e.setAttribute(k,v);}c.forEach(function(x){e.appendChild(typeof x==='string'?document.createTextNode(x):x);});return e;}
    function kv(k,v,hl){return h('div',{},[h('div',{class:'k'},[k]),h('div',{class:'v',style:hl?'color:#065f46':''},[String(v)])]);}
    function Box(d){return h('div',{class:'card'},[h('div',{class:'row'},[h('div',{},[h('div',{class:'k'},['Line']),h('div',{class:'v'},[d.line])]),h('button',{class:'button',onClick:function(){openEdit(d.line)}},['Edit'])]),h('div',{class:'kvgrid'},[kv('Body',d.body),kv('Thickness',d.thickness_mm+' mm'),kv('Size',d.size),kv('Engobe',d.engobe),kv('Product code',d.product_code),kv('Protection glaze',d.protection_glaze),kv('Kiln temperature',d.kiln_temperature_C+' °C',true),kv('Kiln cycle',d.kiln_cycle),kv('Surface',d.surface)])]);}
    function Header(){return h('div',{class:'header'},[h('div',{class:'title'},['Anatolia — Live Production (Static)']),h('div',{class:'spacer'},[]),h('div',{class:'small'},['Europe/Istanbul · '+new Date().toLocaleDateString('en-GB')]),state.authed?h('button',{class:'button',onClick:logout},['Log out']):null]);}
    function Footer(){return h('div',{class:'footer'},['Demo login: name ',h('b',{},['Production']),' · password ',h('b',{},['Prototype'])]);}
    function openEdit(line){state.editing=JSON.parse(JSON.stringify(state.lines[line]));render();}

    function init(){if(typeof localStorage!=='undefined'){state.lines=safeLoad(STORAGE_KEYS.LINES,DEFAULT_LINES);state.history=safeLoad(STORAGE_KEYS.HISTORY,[]);state.counters=safeLoad(STORAGE_KEYS.COUNTERS,{});if(!Array.isArray(state.history)){state.history=[];}if(!state.counters||typeof state.counters!=='object'){state.counters={};}if(state.history.length){rebuildCountersFromHistory();}}render();}

    function persistLines(){safeSet(STORAGE_KEYS.LINES,state.lines);}
    function persistHistory(){safeSet(STORAGE_KEYS.HISTORY,state.history);}
    function persistCounters(){safeSet(STORAGE_KEYS.COUNTERS,state.counters);}

    function queueToast(message,type){clearTimeout(state.toastTimer);state.toast={message:message,type:type||'info'};render();state.toastTimer=setTimeout(function(){state.toast=null;render();},3200);}

    function h(tag,props,children){var el=document.createElement(tag);props=props||{};children=children||[];Object.keys(props).forEach(function(key){var val=props[key];if(key==='class')el.className=val;else if(key==='html')el.innerHTML=val;else if(key==='text')el.textContent=val;else if(/^on[A-Z]/.test(key)){el.addEventListener(key.slice(2).toLowerCase(),val);}else if(key==='for')el.htmlFor=val;else if(key==='type')el.type=val;else if(key==='value')el.value=val;else if(key==='placeholder')el.placeholder=val;else if(key==='href')el.href=val;else if(key==='download')el.download=val;else if(key==='target')el.target=val;else if(key==='readOnly')el.readOnly=!!val;else if(key==='autofocus')el.autofocus=!!val;else el.setAttribute(key,val);});children.forEach(function(child){if(child==null)return;if(typeof child==='string')el.appendChild(document.createTextNode(child));else el.appendChild(child);});return el;}

    function openEdit(lineId){state.editing=deepClone(state.lines[lineId]);render();}
    function closeEdit(){state.editing=null;render();}
    function saveEdit(){var n=state.editing;state.lines[n.line]=n;state.editing=null;render();}
    function EditModal(){if(!state.editing)return document.createDocumentFragment();var l=state.editing;function field(lbl,key,t,ph){t=t||'text';ph=ph||'';var inp=h('input',{value:l[key],placeholder:ph},[]);if(t==='number')inp.setAttribute('type','number');inp.addEventListener('input',function(e){l[key]=(t==='number')?Number(e.target.value):e.target.value;});return h('label',{class:'field'},[h('span',{class:'k'},[lbl]),inp]);}
      return h('div',{class:'modal-outer'},[h('div',{class:'modal-backdrop',onClick:closeEdit},[]),h('div',{class:'modal'},[h('div',{class:'row'},[h('div',{},[h('div',{class:'small'},['Edit Line']),h('div',{class:'title'},[l.line])]),h('button',{class:'button',onClick:closeEdit},['Close'])]),field('Body','body'),field('Thickness (mm)','thickness_mm','number'),field('Size','size'),field('Engobe','engobe'),field('Product code','product_code'),field('Protection glaze','protection_glaze'),field('Kiln temperature (°C)','kiln_temperature_C','number'),field('Kiln cycle','kiln_cycle'),field('Surface','surface'),h('div',{class:'row',style:'margin-top:10px;gap:8px'},[h('button',{class:'button',onClick:saveEdit},['Save changes']),h('div',{class:'small',style:'color:#065f46'},['Saved ✓'])])])]);}
    function Login(){return h('div',{class:'login-wrap'},[h('form',{class:'login',onSubmit:function(e){e.preventDefault();var n=document.getElementById('name').value.trim();var p=document.getElementById('pwd').value.trim();if(n==='Production'&&p==='Prototype'){state.authed=true;render();}else{document.getElementById('err').textContent='Invalid credentials.';}}},[h('div',{class:'title'},['Anatolia — Live Production']),h('div',{class:'small'},['Login required']),h('div',{class:'field'},[h('label',{},['Name']),h('input',{id:'name',placeholder:'Production',autofocus:true},[])]),h('div',{class:'field'},[h('label',{},['Password']),h('input',{id:'pwd',type:'password',placeholder:'Prototype'},[])]),h('div',{id:'err',class:'small',style:'color:#dc2626;min-height:16px;margin-top:4px'},[]),h('button',{type:'submit',class:'button',style:'width:100%;font-weight:600'},['Sign in'])])]);}
    function onEditFieldChange(line,key,coerce){return function(e){var val=e.target.value;if(coerce==='number'){val=Number(val);}line[key]=val;}};
    function saveEdit(){var edited=state.editing;if(!edited)return;state.lines[edited.line]=edited;persistLines();state.editing=null;queueToast('Saved ✓ parameters for '+LINE_META[edited.line].label,'success');render();}

    function openFinish(lineId){state.finishing={lineId:lineId,quantity:'',notes:''};render();}
    function closeFinish(){state.finishing=null;render();}
    function finishSave(){if(!state.finishing)return;var lineId=state.finishing.lineId;var quantity=parseFloat(state.finishing.quantity);if(!isFinite(quantity)||quantity<=0){queueToast('Quantity must be a positive number.','error');return;}var nowIstanbul=getIstanbulDate();var dateKey=formatDateKey(nowIstanbul);var nextCounter=nextCounterFor(dateKey,lineId);var runCode=formatRunCode(dateKey,LINE_META[lineId].number,nextCounter);var snapshot=deepClone(state.lines[lineId]);var run={run_code:runCode,line_id:lineId,line_label:LINE_META[lineId].label,saved_at:new Date().toISOString(),production_date:dateKey,body:snapshot.body,thickness_mm:snapshot.thickness_mm,size:snapshot.size,engobe:snapshot.engobe,product_code:snapshot.product_code,protection_glaze:snapshot.protection_glaze,kiln_temperature_C:snapshot.kiln_temperature_C,kiln_cycle:snapshot.kiln_cycle,surface:snapshot.surface,quantity_sqm:quantity,notes:(state.finishing.notes||''),counter_of_day:nextCounter};state.history.unshift(run);persistHistory();incrementCounter(dateKey,lineId);state.finishing=null;queueToast('Saved ✓ '+runCode,'success');render();}

    function logout(){state.authed=false;render();}
    function App(){if(!state.authed)return Login();var grid=h('div',{class:'grid'},[]);grid.appendChild(Box(state.lines.LA));grid.appendChild(Box(state.lines.LB));grid.appendChild(Box(state.lines.LC));return h('div',{class:'container'},[Header(),grid,Footer(),EditModal(),FinishModal(),HistoryModal()]);}

    function openHistory(){state.historyOpen=true;render();}
    function closeHistory(){state.historyOpen=false;state.historyDetail=null;render();}

    function setHistoryFilter(key,value){state.historyFilters[key]=value;render();}
    function resetHistoryFilters(){state.historyFilters={dateFrom:'',dateTo:'',exactDate:'',line:'',text:''};state.historyDetail=null;render();}

    function applySearchFromBar(){var day=state.searchInputs.day?pad(state.searchInputs.day,2):'';var month=state.searchInputs.month?pad(state.searchInputs.month,2):'';var year=state.searchInputs.year;if(day && month && year){var exact=year+'-'+month+'-'+day;state.historyFilters.exactDate=exact;state.historyFilters.dateFrom='';state.historyFilters.dateTo='';state.historyOpen=true;state.historyDetail=null;render();}else{queueToast('Enter day, month, and year to search.','error');}}

    function setSearchInput(key){return function(e){state.searchInputs[key]=e.target.value.replace(/[^0-9]/g,'').slice(0,key==='year'?4:2);} };

    function quickRange(type){var now=getIstanbulDate();var dateTo=formatDateKey(now);var fromDate=dateTo;if(type==='yesterday'){var y=new Date(now);y.setDate(y.getDate()-1);fromDate=formatDateKey(y);dateTo=fromDate;state.historyFilters.exactDate='';}else if(type==='today'){fromDate=dateTo;state.historyFilters.exactDate='';}else if(type==='last7'){var l7=new Date(now);l7.setDate(l7.getDate()-6);fromDate=formatDateKey(l7);state.historyFilters.exactDate='';}
      state.historyFilters.dateFrom=fromDate;state.historyFilters.dateTo=dateTo;state.historyOpen=true;state.historyDetail=null;render();}

    function filteredHistory(){var list=state.history.slice();var f=state.historyFilters;if(f.exactDate){list=list.filter(function(item){return item.production_date===f.exactDate;});}
      if(f.dateFrom){list=list.filter(function(item){return item.production_date>=f.dateFrom;});}
      if(f.dateTo){list=list.filter(function(item){return item.production_date<=f.dateTo;});}
      if(f.line){list=list.filter(function(item){return item.line_id===f.line;});}
      if(f.text){var q=f.text.toLowerCase();list=list.filter(function(item){var notes=(item.notes||'').toLowerCase();var product=(item.product_code||'').toLowerCase();return product.indexOf(q)>-1||notes.indexOf(q)>-1;});}
      return list;
    }

    function selectHistoryItem(item){state.historyDetail=item;render();}

    function exportHistory(){if(typeof Blob==='undefined'||!window.URL||!URL.createObjectURL){queueToast('Export not supported in this browser.','error');return;}var data=JSON.stringify(state.history,null,2);var date=formatDateKey(getIstanbulDate()).replace(/-/g,'');var blob=new Blob([data],{type:'application/json'});var url=URL.createObjectURL(blob);var a=h('a',{href:url,download:'anatolia-history-'+date+'.json'},['download']);document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);queueToast('History exported.','success');}

    function importHistory(){var input=document.createElement('input');input.type='file';input.accept='application/json';input.addEventListener('change',function(event){var file=event.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(){try{var parsed=JSON.parse(reader.result);if(!Array.isArray(parsed))throw new Error('Invalid format');var merged={};state.history.forEach(function(item){if(item&&item.run_code){merged[item.run_code]=item;}});parsed.forEach(function(item){if(item&&item.run_code){merged[item.run_code]=item;}});var list=[];for(var code in merged){if(Object.prototype.hasOwnProperty.call(merged,code)){list.push(merged[code]);}}state.history=list.sort(function(a,b){return (b.saved_at||'').localeCompare(a.saved_at||'');});persistHistory();rebuildCountersFromHistory();queueToast('History imported.','success');render();}catch(err){console.error('import error',err);queueToast('Import failed — invalid file.','error');}};reader.readAsText(file);});input.click();}

    function Login(){return h('div',{class:'login-wrap'},[h('form',{class:'login',onSubmit:function(e){e.preventDefault();var name=e.target.querySelector('[name="name"]').value.trim();var pwd=e.target.querySelector('[name="pwd"]').value.trim();if(name==='Production'&&pwd==='Prototype'){state.authed=true;render();}else{var err=e.target.querySelector('.error');err.textContent='Invalid credentials.';}}},[
      h('h1',{},['Anatolia — Live Production']),
      h('div',{class:'small'},['Login required']),
      h('div',{class:'field'},[h('label',{for:'name'},['Name']),h('input',{id:'name',name:'name',placeholder:'Production',autofocus:true},[])]),
      h('div',{class:'field'},[h('label',{for:'pwd'},['Password']),h('input',{id:'pwd',name:'pwd',type:'password',placeholder:'Prototype'},[])]),
      h('div',{class:'small error',style:'color:#dc2626;min-height:16px'},[]),
      h('button',{type:'submit',class:'button primary'},['Sign in'])
    ])]);}

    function SearchBar(){return h('div',{class:'search-bar'},[
      h('div',{class:'search-inputs'},[
        h('input',{placeholder:'DD',value:state.searchInputs.day,onInput:setSearchInput('day')},[]),
        h('input',{placeholder:'MM',value:state.searchInputs.month,onInput:setSearchInput('month')},[]),
        h('input',{placeholder:'YYYY',value:state.searchInputs.year,onInput:setSearchInput('year')},[])
      ]),
      h('button',{class:'search-button',onClick:applySearchFromBar},['Search']),
      h('div',{class:'quick-buttons'},[
        h('button',{class:'button',onClick:function(){quickRange('today');}},['Today']),
        h('button',{class:'button',onClick:function(){quickRange('yesterday');}},['Yesterday']),
        h('button',{class:'button',onClick:function(){quickRange('last7');}},['Last 7 days'])
      ])
    ]);
    }

    function Header(){var now=getIstanbulDate();return h('div',{class:'header'},[
      h('div',{class:'header-left'},[
        h('div',{class:'title'},['Anatolia — Live Production']),
        h('div',{class:'small'},['Europe/Istanbul · '+now.toLocaleDateString('en-GB')])
      ]),
      SearchBar(),
      h('div',{class:'spacer'},[]),
      h('button',{class:'button',onClick:openHistory},['History']),
      h('button',{class:'button',onClick:logout},['Log out'])
    ]);
    }

    function kv(label,value,highlight){return h('div',{},[h('div',{class:'k'},[label]),h('div',{class:'v',style:highlight?'color:#065f46':''},[String(value)])]);}

    function Box(line){var meta=LINE_META[line.line];return h('div',{class:'card'},[
      h('div',{class:'row'},[
        h('div',{},[
          h('div',{class:'line-label'},[meta.label]),
          h('div',{class:'line-sub'},['Code '+line.line])
        ]),
        h('div',{class:'row-buttons'},[
          h('button',{class:'button',onClick:function(){openEdit(line.line);}},['Edit']),
          h('button',{class:'button',onClick:function(){openFinish(line.line);}},['Finished production'])
        ])
      ]),
      h('div',{class:'kvgrid'},[
        kv('Body',line.body),
        kv('Thickness',line.thickness_mm+' mm'),
        kv('Size',line.size),
        kv('Engobe',line.engobe),
        kv('Product code',line.product_code),
        kv('Protection glaze',line.protection_glaze),
        kv('Kiln temperature',line.kiln_temperature_C+' °C',true),
        kv('Kiln cycle',line.kiln_cycle),
        kv('Surface',line.surface)
      ])
    ]);
    }

    function EditModal(){if(!state.editing)return document.createDocumentFragment();var line=state.editing;var meta=LINE_META[line.line];var now=getIstanbulDate();var previewDate=formatDateKey(now);var nextCounter=nextCounterFor(previewDate,line.line);var previewCode=formatRunCode(previewDate,meta.number,nextCounter);
      function field(label,key,type){type=type||'text';var inputProps={value:line[key],onInput:onEditFieldChange(line,key,type==='number'?'number':null)};if(type==='number')inputProps.type='number';return h('div',{class:'field'},[h('label',{},[label]),h('input',inputProps,[])]);}
      return h('div',{class:'modal-outer'},[
        h('div',{class:'side-modal'},[
          h('div',{class:'row'},[
            h('div',{},[
              h('div',{class:'small'},['Edit parameters']),
              h('div',{class:'title'},[meta.label, h('span',{class:'tag'},[line.line])])
            ]),
            h('button',{class:'button',onClick:closeEdit},['Close'])
          ]),
          h('div',{class:'field'},[
            h('label',{},['Run code (next)']),
            h('input',{value:previewCode,readOnly:true},[])
          ]),
          field('Body','body'),
          field('Thickness (mm)','thickness_mm','number'),
          field('Size','size'),
          field('Engobe','engobe'),
          field('Product code','product_code'),
          field('Protection glaze','protection_glaze'),
          field('Kiln temperature (°C)','kiln_temperature_C','number'),
          field('Kiln cycle','kiln_cycle'),
          field('Surface','surface'),
          h('div',{class:'modal-actions'},[
            h('button',{class:'button',onClick:closeEdit},['Cancel']),
            h('button',{class:'button primary',onClick:saveEdit},['Save changes'])
          ])
        ])
      ]);
    }

    function FinishModal(){if(!state.finishing)return document.createDocumentFragment();var meta=LINE_META[state.finishing.lineId];var now=getIstanbulDate();var dateKey=formatDateKey(now);var counter=nextCounterFor(dateKey,meta.id);var runCode=formatRunCode(dateKey,meta.number,counter);
      return h('div',{class:'modal-outer'},[
        h('div',{class:'center-modal'},[
          h('div',{class:'row'},[
            h('div',{},[
              h('div',{class:'small'},['Finished production']),
              h('div',{class:'title'},[meta.label])
            ]),
            h('button',{class:'button',onClick:closeFinish},['Close'])
          ]),
          h('div',{class:'field'},[h('label',{},['Run code']),h('input',{value:runCode,readOnly:true},[])]),
          h('div',{class:'field'},[h('label',{},['Quantity (sqm)']),h('input',{type:'number',min:'0',step:'0.01',value:state.finishing.quantity,onInput:function(e){state.finishing.quantity=e.target.value;}} ,[])]),
          h('div',{class:'field'},[h('label',{},['Notes (optional)']),h('textarea',{value:state.finishing.notes,onInput:function(e){state.finishing.notes=e.target.value;}},[])]),
          h('div',{class:'modal-actions'},[
            h('button',{class:'button',onClick:closeFinish},['Cancel']),
            h('button',{class:'button primary',onClick:finishSave},['Save'])
          ])
        ])
      ]);
    }

    function buildHistoryTable(rows){var table=h('table',{class:'history-table'},[
      h('thead',{},[
        h('tr',{},[
          h('th',{},['Date']),
          h('th',{},['Code']),
          h('th',{},['Line']),
          h('th',{},['Product code']),
          h('th',{},['Quantity']),
          h('th',{},['Notes'])
        ])
      ]),
      h('tbody',{},rows.map(function(item){return h('tr',{onClick:function(){selectHistoryItem(item);},class:item===state.historyDetail?'selected':''},[
        h('td',{},[item.production_date]),
        h('td',{},[item.run_code]),
        h('td',{},[item.line_id]),
        h('td',{},[item.product_code]),
        h('td',{},[item.quantity_sqm.toFixed(2)+' m²']),
        h('td',{},[item.notes.slice(0,30)+(item.notes.length>30?'...':'')])
      ]);}))
    ]);return table;}

    function historyDetailView(item){return h('div',{class:'history-detail'},[
      h('div',{},[h('b',{},['Run Code: ']),item.run_code]),
      h('div',{},[h('b',{},['Line: ']),item.line_label+' ('+item.line_id+')']),
      h('div',{},[h('b',{},['Date: ']),item.production_date]),
      h('div',{},[h('b',{},['Product Code: ']),item.product_code]),
      h('div',{},[h('b',{},['Quantity: ']),item.quantity_sqm.toFixed(2)+' m²']),
      h('div',{},[h('b',{},['Kiln Temp: ']),item.kiln_temperature_C+' °C']),
      h('div',{},[h('b',{},['Kiln Cycle: ']),item.kiln_cycle]),
      h('div',{},[h('b',{},['Notes: ']),item.notes||'(none)'])
    ]);}

    function HistoryModal(){if(!state.historyOpen)return document.createDocumentFragment();var rows=filteredHistory();return h('div',{class:'modal-outer'},[
      h('div',{class:'history-modal'},[
        h('div',{class:'history-actions'},[
          h('div',{class:'title'},['Production history']),
          h('div',{class:'row-buttons'},[
            h('button',{class:'button',onClick:exportHistory},['Export JSON']),
            h('button',{class:'button',onClick:importHistory},['Import JSON']),
            h('button',{class:'button',onClick:closeHistory},['Close'])
          ])
        ]),
        h('div',{class:'filters'},[
          fieldControl('Date from','dateFrom','date'),
          fieldControl('Date to','dateTo','date'),
          fieldControl('Exact date','exactDate','date'),
          selectControl('Line','line'),
          textControl('Search notes/product','text')
        ]),
        h('div',{class:'row-buttons',style:'gap:6px'},[
          h('button',{class:'button',onClick:resetHistoryFilters},['Clear filters'])
        ]),
        h('div',{class:'history-body'},[ rows.length?buildHistoryTable(rows):h('div',{class:'history-empty'},['No saved runs.']) ]),
        state.historyDetail?historyDetailView(state.historyDetail):null
      ])
    ]);

      function fieldControl(label,key,type){return h('div',{class:'field'},[
        h('label',{},[label]),
        h('input',{type:type,value:state.historyFilters[key],onInput:function(e){setHistoryFilter(key,e.target.value);}},[])
      ]);}
      function textControl(label,key){return h('div',{class:'field'},[
        h('label',{},[label]),
        h('input',{value:state.historyFilters[key],placeholder:'Search…',onInput:function(e){setHistoryFilter(key,e.target.value);}},[])
      ]);}
      function selectControl(label,key){return h('div',{class:'field'},[
        h('label',{},[label]),
        h('select',{value:state.historyFilters[key],onChange:function(e){setHistoryFilter(key,e.target.value);}},[
          h('option',{value:''},['All lines']),
          h('option',{value:'LA'},['First line']),
          h('option',{value:'LB'},['Second line']),
          h('option',{value:'LC'},['Third line']) // FIX: Added closing option tag here to fix the history modal closing issue.
        ])
      ]);}
    } // End of HistoryModal (closing bracket was missing/incorrectly placed)

    function render(){document.getElementById('app').innerHTML='';document.getElementById('app').appendChild(App());if(state.toast){document.getElementById('app').appendChild(Toast());}}
    function Toast(){if(!state.toast)return document.createDocumentFragment();return h('div',{class:'toast '+(state.toast.type||'info')},[state.toast.message]);}

    init();
    // One more issue was found in the HistoryModal's selectControl: a missing closing option tag.
    // I have fixed it above in the HistoryModal function as well.
  })();
  </script>
</body>
</html>
